/* PublicaMundi Mapping API version 0.1.0 2014-12-09 */

!function(a,b){"use strict";"undefined"!=typeof b&&(b.define("PublicaMundi.Leaflet"),b.Leaflet.Framework="leaflet",b.registerFrameworkResolver(b.Leaflet.Framework,function(){return b.isObject(L)&&b.isFunction(L.Map)?!0:!1}))}(window,PublicaMundi),toGeoJSON=function(){"use strict";function a(a){if(!a||!a.length)return 0;for(var b=0,c=0;b<a.length;b++)c=(c<<5)-c+a.charCodeAt(b)|0;return c}function b(a,b){return a.getElementsByTagName(b)}function c(a,b){return a.getAttribute(b)}function d(a,b){return parseFloat(c(a,b))}function e(a,c){var d=b(a,c);return d.length?d[0]:null}function f(a){return a.normalize&&a.normalize(),a}function g(a){for(var b=0,c=[];b<a.length;b++)c[b]=parseFloat(a[b]);return c}function h(a){var b={};for(var c in a)a[c]&&(b[c]=a[c]);return b}function i(a){return a&&f(a),a&&a.firstChild&&a.firstChild.nodeValue||""}function j(a){return g(a.replace(p,"").split(","))}function k(a){for(var b=a.replace(q,"").split(r),c=[],d=0;d<b.length;d++)c.push(j(b[d]));return c}function l(a){var b=[d(a,"lon"),d(a,"lat")],c=e(a,"ele");return c&&b.push(parseFloat(i(c))),b}function m(){return{type:"FeatureCollection",features:[]}}function n(a){return o.serializeToString(a)}var o,p=/\s*/g,q=/^\s*|\s*$/g,r=/\s+/;"undefined"!=typeof XMLSerializer?o=new XMLSerializer:"object"!=typeof exports||"object"!=typeof process||process.browser||(o=new(require("xmldom").XMLSerializer));var s={kml:function(d){function f(a){var b,c;return a=a||"","#"===a.substr(0,1)&&(a=a.substr(1)),(6===a.length||3===a.length)&&(b=a),8===a.length&&(c=parseInt(a.substr(0,2),16)/255,b=a.substr(2)),[b,isNaN(c)?void 0:c]}function h(a){return g(a.split(" "))}function l(a){var c=b(a,"coord","gx"),d=[];0===c.length&&(c=b(a,"gx:coord"));for(var e=0;e<c.length;e++)d.push(h(i(c[e])));return d}function o(a){var c,d,f,g,h,m=[];if(e(a,"MultiGeometry"))return o(e(a,"MultiGeometry"));if(e(a,"MultiTrack"))return o(e(a,"MultiTrack"));if(e(a,"gx:MultiTrack"))return o(e(a,"gx:MultiTrack"));for(f=0;f<s.length;f++)if(d=b(a,s[f]))for(g=0;g<d.length;g++)if(c=d[g],"Point"==s[f])m.push({type:"Point",coordinates:j(i(e(c,"coordinates")))});else if("LineString"==s[f])m.push({type:"LineString",coordinates:k(i(e(c,"coordinates")))});else if("Polygon"==s[f]){var n=b(c,"LinearRing"),p=[];for(h=0;h<n.length;h++)p.push(k(i(e(n[h],"coordinates"))));m.push({type:"Polygon",coordinates:p})}else("Track"==s[f]||"gx:Track"==s[f])&&m.push({type:"LineString",coordinates:l(c)});return m}function p(a){var c,d=o(a),g={},h=i(e(a,"name")),j=i(e(a,"styleUrl")),k=i(e(a,"description")),l=e(a,"TimeSpan"),m=e(a,"ExtendedData"),n=e(a,"LineStyle"),p=e(a,"PolyStyle");if(!d.length)return[];if(h&&(g.name=h),j&&r[j]&&(g.styleUrl=j,g.styleHash=r[j]),k&&(g.description=k),l){var q=i(e(l,"begin")),s=i(e(l,"end"));g.timespan={begin:q,end:s}}if(n){var t=f(i(e(n,"color"))),u=t[0],v=t[1],w=parseFloat(i(e(n,"width")));u&&(g.stroke=u),isNaN(v)||(g["stroke-opacity"]=v),isNaN(w)||(g["stroke-width"]=w)}if(p){var x=f(i(e(p,"color"))),y=x[0],z=x[1],A=i(e(p,"fill")),B=i(e(p,"outline"));y&&(g.fill=y),isNaN(z)||(g["fill-opacity"]=z),A&&(g["fill-opacity"]="1"===A?1:0),B&&(g["stroke-opacity"]="1"===B?1:0)}if(m){var C=b(m,"Data"),D=b(m,"SimpleData");for(c=0;c<C.length;c++)g[C[c].getAttribute("name")]=i(e(C[c],"value"));for(c=0;c<D.length;c++)g[D[c].getAttribute("name")]=i(D[c])}return[{type:"Feature",geometry:1===d.length?d[0]:{type:"GeometryCollection",geometries:d},properties:g}]}for(var q=m(),r={},s=["Polygon","LineString","Point","Track","gx:Track"],t=b(d,"Placemark"),u=b(d,"Style"),v=0;v<u.length;v++)r["#"+c(u[v],"id")]=a(n(u[v])).toString(16);for(var w=0;w<t.length;w++)q.features=q.features.concat(p(t[w]));return q},gpx:function(a){function c(a,c){var d=b(a,c),e=[],f=d.length;if(!(2>f)){for(var g=0;f>g;g++)e.push(l(d[g]));return e}}function d(a){for(var d,e=b(a,"trkseg"),f=[],g=0;g<e.length;g++)d=c(e[g],"trkpt"),d&&f.push(d);return 0!==f.length?{type:"Feature",properties:j(a),geometry:{type:1===f.length?"LineString":"MultiLineString",coordinates:1===f.length?f[0]:f}}:void 0}function f(a){var b=c(a,"rtept");if(b)return{type:"Feature",properties:j(a),geometry:{type:"LineString",coordinates:b}}}function g(a){var b=j(a);return b.sym=i(e(a,"sym")),{type:"Feature",properties:b,geometry:{type:"Point",coordinates:l(a)}}}function j(a){var b,c=["name","desc","author","copyright","link","time","keywords"],d={};for(b=0;b<c.length;b++)d[c[b]]=i(e(a,c[b]));return h(d)}var k,n,o=b(a,"trk"),p=b(a,"rte"),q=b(a,"wpt"),r=m();for(k=0;k<o.length;k++)n=d(o[k]),n&&r.features.push(n);for(k=0;k<p.length;k++)n=f(p[k]),n&&r.features.push(n);for(k=0;k<q.length;k++)r.features.push(g(q[k]));return r}};return s}(),"undefined"!=typeof module&&(module.exports=toGeoJSON),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(_unproject=function(a){var b=c.point(a[0],a[1]).divideBy(6378137);return c.CRS.EPSG3857.projection.unproject(b)},_project=function(a){return center=c.CRS.EPSG3857.projection.project(a).multiplyBy(6378137)},b.define("PublicaMundi.Leaflet"),b.Leaflet.Map=b.Class(b.Map,{addOverlay:function(a){var b=new c.popup({className:"hideparent",closeButton:!1}).setLatLng(this._map.getCenter());return b.setContent(a),b.addTo(this._map),this._popup=b,b},setOverlayPosition:function(a,b){var c=[b[0]/6378137,b[1]/6378137];a.setLatLng(c)},initialize:function(a){if(b.Map.prototype.initialize.call(this,a),this._map=b.isClass("L.Map")&&a instanceof c.Map?a:c.map(a.target,{center:_unproject(a.center),zoom:a.zoom,maxZoom:a.maxZoom,minZoom:a.minZoom,attributionControl:!1,closePopupOnClick:!1}),this._listen(),"undefined"!=typeof a.layers&&b.isArray(a.layers))for(var d=0;d<a.layers.length;d++)this.createLayer(a.layers[d])},setCenter:function(a,c){b.isArray(a)?this._map.setView(_unproject(a),this._map.getZoom()):this._map.setView(_unproject([a,c]),this._map.getZoom())},getCenter:function(){var a=this._map.getCenter();return a=c.CRS.EPSG3857.projection.project(a).multiplyBy(6378137),[a.x,a.y]},setZoom:function(a){this._map.setView(this._map.getCenter(),a)},getZoom:function(){return this._map.getZoom()},getProjection:function(){return"EPSG:3857"},getTarget:function(){return this._map.getTarget()},addLayer:function(a){a._options.visible!==!1&&this._map.addLayer(a.getLayer()),a._addToControl(),a.update()},setExtent:function(a,b){if(null!==a){var d;d="EPSG:4326"==b?a:"EPSG:3857"==b?_unproject(a):null;var e=new c.LatLng(d[1],d[0]),f=new c.LatLng(d[3],d[2]);this._map.fitBounds(new c.LatLngBounds(e,f))}},_listen:function(){var a=this;this._map.on("moveend",function(){a._setViewBox();var b=a.getLayers();$.each(b,function(a,b){b.update()})})},_setViewBox:function(){var a=_project(this._map.getBounds().getSouthWest()),b=_project(this._map.getBounds().getNorthEast());this._viewbox=a.x+","+a.y+","+b.x+","+b.y},setLayerControl:function(){return this._control=new c.control.layers,this._control.addTo(this._map),this._control}}),b.locator.register("PublicaMundi.Map",b.Leaflet.Map))}(window,window.PublicaMundi,L),function(a,b,c){if("undefined"!=typeof b&&"undefined"!=typeof c){var d=function(a){var b=null;return $.each(a,function(a,c){c=c["@attributes"],"EPSG:4326"==c.CRS?b=[parseFloat(c.miny),parseFloat(c.minx),parseFloat(c.maxy),parseFloat(c.maxx)]:"CRS:84"==c.CRS&&(b=[parseFloat(c.minx),parseFloat(c.miny),parseFloat(c.maxx),parseFloat(c.maxy)])}),b};b.define("PublicaMundi.Leaflet.Layer"),b.Leaflet.Layer.WMS=b.Class(b.Layer,{_addToControl:function(){var a=this._map,b=this._options.title;a.getLayerControl()&&a.getLayerControl().addOverlay(this._layer,b)},fitToMap:function(){var a=this,b=this._options;"undefined"==typeof b.bbox?(console.log("Getting Capabilities..."),$.ajax(b.url+"?service=WMS&request=GetCapabilities").then(function(c){c=xmlToJson(c),console.log(c);var e=c.WMS_Capabilities.Capability.Layer.Layer;$.each(e,function(c,e){if(e.Name&&e.Name["#text"]&&e.Name["#text"]==b.params.layers){var f=d(e.BoundingBox);return a._extent=f,a._layer.on("load",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1}})})):(console.log("Bbox option found"),this._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}))},initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._layer=c.tileLayer.wms(a.url,{layers:a.params.layers,format:"image/png",transparent:!0})}}),b.registry.registerLayerType({layer:b.LayerType.WMS,framework:b.Leaflet.Framework,type:"PublicaMundi.Layer.WMS",factory:b.Leaflet.Layer.WMS})}}(window,window.PublicaMundi,L),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.Leaflet.Layer"),b.Leaflet.Layer.WFS=b.Class(b.Layer,{_addToControl:function(){var a=this._map,b=this._options.title;a.getLayerControl()&&a.getLayerControl().addOverlay(this._layer,b)},fitToMap:function(){var a=this,b=this._options;"undefined"==typeof b.bbox?(console.log("Getting Capabilities..."),$.ajax(b.url+"?service=WFS&request=GetCapabilities").then(function(c){c=xmlToJson(c);var d=c["wfs:WFS_Capabilities"].FeatureTypeList.FeatureType;$.each(d,function(c,d){if(d.Name&&d.Name["#text"]&&d.Name["#text"]==b.params.layers){var e=d.WGS84BoundingBox,f=null,g=null;return"undefined"==typeof e?(e=d["ows:WGS84BoundingBox"],f=e["ows:LowerCorner"]["#text"],g=e["ows:UpperCorner"]["#text"]):(f=e.LowerCorner["#text"],g=e.UpperCorner["#text"]),"undefined"!=typeof e&&(f=f.split(" "),g=g.split(" "),bboxfloat=[parseFloat(f[0]),parseFloat(f[1]),parseFloat(g[0]),parseFloat(g[1])]),a._extent=bboxfloat,a._layer.once("layeradd",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1}})})):(console.log("Bbox option found"),a._layer._map.once("layeradd",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}))},update:function(){"0,0,0,0"==this._map._getViewBox()&&this._map._setViewBox();var a=this._map._getViewBox();$.ajax({type:"GET",url:this._options.url+"?service=WFS&request=GetFeature&typename="+this._options.params.layers+"&srsname=EPSG:4326&outputFormat=json&bbox="+a+",EPSG:3857",dataType:"json",context:this,success:function(a){console.log("success"),this._layer.clearLayers(),this._layer.addData(a)},failure:function(){console.log("failure")}})},initialize:function(a){function d(a){var b=a.target;b.setStyle({opacity:1,weight:3,color:"#3399CC"}),c.Browser.ie||c.Browser.opera||b.bringToFront()}function e(){f._layer.resetStyle(f._map._highlight)}b.Layer.prototype.initialize.call(this,a);var f=this,g=null;b.isFunction(a.click)&&(g=function(b){a.click(f,[b.target.feature.properties],[6378137*b.latlng.lat,6378137*b.latlng.lng]),map._highlight?map._highlight!==b.target&&(e(b),map._highlight=b.target,d(b)):(map._highlight=b.target,d(b))}),this._layer=c.geoJson(null,{style:{color:"#3399CC",weight:1.25,opacity:1,fillColor:"#FFFFFF",fillOpacity:.4},pointToLayer:function(a,b){return c.circleMarker(b,{radius:5,fillColor:"#FFFFFF",fillOpacity:.4,color:"#3399CC",weight:1.25,opacity:1})},onEachFeature:function(a,c){b.isFunction(g)&&c.on({click:g})}})}}),b.registry.registerLayerType({layer:b.LayerType.WFS,framework:b.Leaflet.Framework,type:"PublicaMundi.Layer.WFS",factory:b.Leaflet.Layer.WFS}))}(window,window.PublicaMundi,L),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.Leaflet.Layer"),b.Leaflet.Layer.Tile=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._layer=c.tileLayer(a.url)},_addToControl:function(){this._map.getLayerControl()&&this._map.getLayerControl().addBaseLayer(this._layer,this._options.title)}}),b.registry.registerLayerType({layer:b.LayerType.TILE,framework:b.Leaflet.Framework,type:"PublicaMundi.Layer.Tile",factory:b.Leaflet.Layer.Tile}))}(window,window.PublicaMundi,L),function(a,b,c,d){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.Leaflet.Layer"),b.Leaflet.Layer.KML=b.Class(b.Layer,{fitToMap:function(){},_addToControl:function(){this._map.getLayerControl()&&this._map.getLayerControl().addOverlay(this._layer,this._options.title)},initialize:function(a){function e(a){var b=a.target;b.setStyle({opacity:1,weight:3,color:"#3399CC"}),c.Browser.ie||c.Browser.opera||b.bringToFront()}function f(){g._layer.resetStyle(g._map._highlight)}b.Layer.prototype.initialize.call(this,a),!b.isDefined(a.projection);var g=this,h=null;b.isFunction(a.click)&&(h=function(b){a.click(g,[b.target.feature.properties],[6378137*b.latlng.lat,6378137*b.latlng.lng]),map._highlight?map._highlight!==b.target&&(f(b),map._highlight=b.target,e(b)):(map._highlight=b.target,e(b))}),this._layer=c.geoJson(null,{style:{color:"#3399CC",weight:1.25,opacity:1,fillColor:"#FFFFFF",fillOpacity:.4},pointToLayer:function(a,b){return c.circleMarker(b,{radius:5,fillColor:"#FFFFFF",fillOpacity:.4,color:"#3399CC",weight:1.25,opacity:1})},onEachFeature:function(a,c){b.isFunction(h)&&c.on({click:h})},async:!0}),d.ajax({type:"GET",url:a.url,dataType:"xml",context:this,success:function(a){var b=toGeoJSON.kml(a);this._layer.addData(b);var c=this._layer.getBounds(),d=c.getSouthWest(),e=c.getNorthEast();this._extent=[d.lng,d.lat,e.lng,e.lat]}})}}),b.registry.registerLayerType({layer:b.LayerType.KML,framework:b.Leaflet.Framework,type:"PublicaMundi.Layer.KML",factory:b.Leaflet.Layer.KML}),b.isDefined(b.Map)&&(b.Map.prototype.KML=function(a){a.type=a.type||b.LayerType.KML,this.createLayer(a)}))}(window,window.PublicaMundi,L,jQuery),function(a,b,c,d){if("undefined"!=typeof b&&"undefined"!=typeof c){b.define("PublicaMundi.Leaflet.Layer");b.Leaflet.Layer.GeoJson=b.Class(b.Layer,{_addToControl:function(){this._map.getLayerControl()&&this._map.getLayerControl().addOverlay(this._layer,this._options.title)},fitToMap:function(){var a=this;a._layer.on("layeradd",function(){latlngbounds=a._layer.getBounds();var b=[latlngbounds._southWest.lng,latlngbounds._southWest.lat,latlngbounds._northEast.lng,latlngbounds._northEast.lat];a._extent&&(b[0]<a._extent[0]&&(a._extent[0]=b[0]),b[1]<a._extent[1]&&(a._extent[1]=b[1]),b[2]>a._extent[2]&&(a._extent[2]=b[2]),b[3]>a._extent[3]&&(a._extent[3]=b[3])),a.getMap().setExtent(b,"EPSG:4326")})},initialize:function(a){function e(a){var b=a.target;b.setStyle({opacity:1,weight:3,color:"#3399CC"}),c.Browser.ie||c.Browser.opera||b.bringToFront()}function f(){g._layer.resetStyle(g._map._highlight)}b.Layer.prototype.initialize.call(this,a);var g=this;!b.isDefined(a.projection);var h=null;b.isFunction(a.click)&&(h=function(b){a.click(g,[b.target.feature.properties],[6378137*b.latlng.lat,6378137*b.latlng.lng]),map._highlight?map._highlight!==b.target&&(f(b),map._highlight=b.target,e(b)):(map._highlight=b.target,e(b))}),this._layer=c.geoJson(null,{style:{color:"#3399CC",weight:1.25,opacity:1,fillColor:"#FFFFFF",fillOpacity:.4},pointToLayer:function(a,b){return c.circleMarker(b,{radius:5,fillColor:"#FFFFFF",fillOpacity:.4,color:"#3399CC",weight:1.25,opacity:1})},onEachFeature:function(a,c){b.isFunction(h)&&c.on({click:h})}}),d.ajax({type:"GET",url:a.url,dataType:"json",context:this,success:function(a){this._layer.addData(a);var b=this._layer.getBounds(),c=b.getSouthWest(),d=b.getNorthEast();this._extent=[c.lng,c.lat,d.lng,d.lat]}})}}),b.registry.registerLayerType({layer:b.LayerType.GeoJSON,framework:b.Leaflet.Framework,type:"PublicaMundi.Layer.GeoJson",factory:b.Leaflet.Layer.GeoJson}),b.isDefined(b.Map)&&(b.Map.prototype.geoJSON=function(a){a.type=a.type||b.LayerType.GeoJSON,this.createLayer(a)})}}(window,window.PublicaMundi,L,jQuery);
//# sourceMappingURL=publicamundi.leaflet.js.map